name: Debug and assign Copilot to new issues
on:
  issues:
    types:
      - opened
jobs:
  assign-copilot:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
      repository-projects: read  # Añadido
      metadata: read             # Añadido
    steps:
      - name: Check Copilot availability with REST API
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // Intentar obtener assignees disponibles mediante REST API
            try {
              const { data: assignees } = await github.rest.issues.listAssignees({
                owner,
                repo,
                per_page: 100
              });
              
              core.info('Available assignees via REST:');
              assignees.forEach(assignee => {
                core.info(`- ${assignee.login} (type: ${assignee.type})`);
              });
              
              // Buscar Copilot
              const copilot = assignees.find(a => 
                a.login.toLowerCase().includes('copilot')
              );
              
              if (copilot) {
                core.info(`Found Copilot: ${copilot.login}`);
              } else {
                core.info('Copilot not found in assignees list');
              }
            } catch (error) {
              core.error(`Error: ${error.message}`);
            }
            
      - name: Try direct assignment via REST API
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            try {
              // Intentar asignar directamente con diferentes nombres
              const possibleNames = ['copilot', 'copilot-swe-agent', 'Copilot'];
              
              for (const name of possibleNames) {
                try {
                  await github.rest.issues.addAssignees({
                    owner,
                    repo,
                    issue_number: issueNumber,
                    assignees: [name]
                  });
                  core.info(`Successfully assigned to ${name}`);
                  return;
                } catch (e) {
                  core.info(`Failed to assign to ${name}: ${e.message}`);
                }
              }
              
              core.setFailed('Could not assign to any Copilot variant');
            } catch (error) {
              core.setFailed(`Error: ${error.message}`);
            }
